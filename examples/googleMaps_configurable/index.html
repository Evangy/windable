<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Wind Animation Google Maps</title>

    <script src="./../../dist/windable.js" defer></script>

    <script src="https://maps.googleapis.com/maps/api/js" defer></script>
    <script src="https://google-maps-utility-library-v3.googlecode.com/svn-history/r377/trunk/canvaslayer/src/CanvasLayer.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" defer></script>

    <style>
      html, body, #google-map-canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0 0 0 0;
      }
      #altitude-menu, #colors-menu, #particles-menu, #speed-menu {
        position: absolute;
        width: 200px;
        top: 10px;
        right: 10px;
        background-color: lightgrey;
        padding: 10px;
      }

      label {
        padding: 5px;
        display: block;
      }
      select {
        width: 100%;
      }
      input {
        width: 100%;
      }

      #colors-menu {
        top: 90px;
      }

      #particles-menu {
        top: 170px;
      }

      #speed-menu {
        top: 250px;
      }
    </style>
  </head>

  <body>
    <div id="google-map-canvas"></div>

    <div id="altitude-menu">
      <label>Select Altitude (millibars)</label>
      <select id="millibar-levels"></select>
    </div>

    <div id="colors-menu">
      <label>Select Color Scheme</label>
      <select id="color-schemes"></select>
    </div>

    <div id="particles-menu">
      <label>Particle Reduction</label>
      <input id="particles-range" type="range" value="75" step="1">
    </div>

    <div id="speed-menu">
      <label>Particle Speed</label>
      <input id="speed-range" type="range" step="1" max="1000" value="50">
    </div>

    <script type="text/javascript">
      window.onload = function() {
        // Initialize the map.
        const element = document.getElementById('google-map-canvas');
        const map = new google.maps.Map(element, {
          zoom: 3,
          center: new google.maps.LatLng(39.3, -45.8),
          styles: [
            {featureType: 'water', stylers: [{ color: '#ffffff'}]},
            {featureType: 'poi', stylers: [{visibility: 'off'}]}
          ]
        });

        // Populate the select menu with millibar levels.
        const menu = document.getElementById('millibar-levels');
        const colorsMenu = document.getElementById('color-schemes');
        const particleInput = document.getElementById('particles-range');
        const speedInput = document.getElementById('speed-range');

        altitudeModel.levels.forEach(level => {
          const select = document.createElement('option')
          select.innerHTML = level;
          menu.appendChild(select);
        });

        // // Populate the colors menu.
        const colors = Object.keys(palettes);
        colors.forEach(palette => {
          const select = document.createElement('option');
          select.innerHTML = palette;
          colorsMenu.appendChild(select);
        });

        colorsMenu.selectedIndex = colors.indexOf('default');
        menu.selectedIndex = altitudeModel.levels.indexOf(altitudeModel.millibars);

import {formatTime} from '../utilities/functions';

/**
 * Stores altitude data.
 */
export class AltitudeModel {
  /**
   * Constructs an altitude model with optional configuration
   * @param {Object=} settings Optional settings:
   *  {
   *    data: A hash of existing wind data.
   *    levels: An array of discrete millibar levels.
   *    millibars: The starting selected millibars level.
   *  }
   */
  constructor(settings={}) {
    this.data = settings.data || {};
    this.levels = settings.levels ||
      [200, 250, 300, 400, 500, 700, 850, 925, 1000];
    this.millibars = settings.millibars || this.levels[8];
  }


  /**
   * Creates a key hash from a config object.
   * @param {Object=} config An optional config object:
   *  {time: string|Date, millibars: number}
   * @return {!Promise} A promise.
   */
  get(config={}) {
    config = Object.assign({
      time: new Date(),
      millibars: this.millibars
    }, config);

    if (config.time instanceof Date) {
      config.time = formatTime(config.time);
    }

    const key = this.key(config);

    if (!this.data[key]) {
      this.data[key] = this.fetch(config);
    }

    this.millibars = config.millibars;
    return this.data[key];
  }


  /**
   * Creates a key hash from a config object.
   * @param {!Object} config A config object:
   *  {time: string, millibars: number}
   * @return {string} A key hash.
   */
  key(config) {
    return JSON.stringify(config);
  }


  /**
   * Fetches wind data based on a time and millibar level. Uses browser fetch.
   * Override window.fetch with your own Promise if browser support is an issue.
   * @param {!Object} config A config object:
   *  {time: string, millibars: number}
   * @return {!Promise} A promise.
   */
  fetch(config) {
    return fetch(this.url(config), {method: 'get'})
      .then(response => response.json())
      .then(json => json)
      .catch(err => Promise.resolve(err));
  }


  /**
   * URL from which to fetch data.
   * @param {!Object} config A config object:
   *  {time: string, millibars: number}
   * @return {string} A url string.
   */
   url(config) {
    return `/wind?time=${config.time}&millibars=${config.millibars}`
   }
};



        // Fetch data for 700 millibars.
        const mapDataUrl = 'https://raw.githubusercontent.com/dannycochran/windable/master/data/2016040900_700.json'
        d3.json(mapDataUrl, (err, windData) => {
          const windMap = new WindMap({
            canvas: new CanvasLayer({map: map}).canvas,
            data: windData,
            extent: () => {
              return {
                width: element.clientWidth,
                height: element.clientHeight,
                latlng:[
                  [map.getBounds().j.j, map.getBounds().R.R],
                  [map.getBounds().j.R, map.getBounds().R.j]
                ]
              };
            }
          });

          ['bounds_changed', 'resize'].forEach(listener => {
            map.addListener(listener, windMap.update.bind(windMap));
          });

          // UI STUFF
          const onSelectAltitude = function(e) {
            const selectedIndex = menu.selectedIndex;
            menu.disabled = true;
            altitudeModel.get({
              time: windDate,
              millibars: altitudeModel.levels[selectedIndex]
            }).then((data) => {
              windMap.update({data: data});
              menu.disabled = false;
            });
          };

          const onSelectColor = function(e) {
            const selectedIndex = colorsMenu.selectedIndex;
            windMap.update({colorScheme: palettes[colors[selectedIndex]]});
          };

          const onChangeParticleCount = function(e) {
            const value = Math.max(Number(e.currentTarget.value) / 100, 0.01);
            windMap.update({particleReduction: value});
          };

          const onChangeParticleSpeed = function(e) {
            const value = parseFloat(e.currentTarget.value) * 0.0000001;
            windMap.update({velocityScale: value});
          };

          speedInput.addEventListener('change', onChangeParticleSpeed);
          particleInput.addEventListener('change', onChangeParticleCount);
          menu.addEventListener('change', onSelectAltitude);
          colorsMenu.addEventListener('change', onSelectColor);
        });
      };
    </script>
  </body>
</html>
